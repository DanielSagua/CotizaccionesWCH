{% extends "layouts/main.njk" %}
{% set title = "Detalle Solicitud #" ~ solicitud.id_solicitud %}

{% block content %}
<div class="d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h4 mb-0">Solicitud #{{ solicitud.id_solicitud }}</h1>
    <div class="text-muted small">
      {{ solicitud.cliente }} · {{ solicitud.estado }}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="/solicitudes">Volver</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-12 col-lg-7">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-2">
          <div class="text-muted small">Asunto</div>
          <div class="fw-semibold">{{ solicitud.asunto }}</div>
        </div>

        <div class="mb-2">
          <div class="text-muted small">Detalle</div>
          <div style="white-space: pre-wrap;">{{ solicitud.detalle or '-' }}</div>
        </div>

        <hr>

        <div class="row g-2 small">
          <div class="col-12 col-md-6">
            <div class="text-muted">Owner</div>
            <div>{{ solicitud.owner_nombre }} ({{ solicitud.owner_username }})</div>
          </div>
          <div class="col-12 col-md-6">
            <div class="text-muted">Asignado</div>
            <div>{{ solicitud.assigned_nombre or '-' }}{% if solicitud.assigned_username %} ({{ solicitud.assigned_username }}){% endif %}</div>
          </div>
          <div class="col-12 col-md-6">
            <div class="text-muted">Creación (UTC)</div>
<div>{{ solicitud.created_at_utc | fmtDT }}</div>
          </div>
          <div class="col-12 col-md-6">
            <div class="text-muted">Deadline (UTC)</div>
<div>{{ solicitud.deadline_utc | fmtDT }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white">
      <div class="d-flex gap-2">
  {% if canEdit %}
    <a class="btn btn-primary" href="/solicitudes/{{ solicitud.id_solicitud }}/editar">Editar</a>
  {% endif %}
  <a class="btn btn-outline-secondary" href="/solicitudes">Volver</a>
</div>

        <div class="fw-semibold">Historial</div>
        <div class="text-muted small">Últimos movimientos</div>
      </div>
      <div class="card shadow-sm mb-3">
  <div class="card-header bg-white">
    <div class="fw-semibold">Acciones</div>
  </div>
  <div class="card-body">

    {% if canAssign %}
      <form method="post" action="/solicitudes/{{ solicitud.id_solicitud }}/asignar" class="row g-2 mb-3">
        <div class="col-12">
          <label class="form-label">Asignar Analista</label>
          <select class="form-select" name="assigned_user_id">
            <option value="">(Sin asignar)</option>
            {% for a in analistas %}
              <option value="{{ a.id_user }}" {% if solicitud.assigned_username and (a.username == solicitud.assigned_username) %}selected{% endif %}>
                {{ a.nombre }} ({{ a.username }})
              </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-outline-primary">Guardar asignación</button>
        </div>
      </form>
      <hr>
    {% endif %}

    {% if canChangeStatus %}
      <form method="post" action="/solicitudes/{{ solicitud.id_solicitud }}/estado" class="row g-2">
        <div class="col-12">
          <label class="form-label">Cambiar Estado</label>
          <select class="form-select" name="id_estado" required>
            {% for e in estados %}
              <option value="{{ e.id_estado }}" {% if e.nombre == solicitud.estado %}selected{% endif %}>{{ e.nombre }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12">
          <button class="btn btn-outline-primary">Actualizar estado</button>
        </div>
      </form>
    {% endif %}

  </div>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-header bg-white">
    <div class="fw-semibold">Comentarios</div>
    <div class="text-muted small">Tipo chat (últimos 200)</div>
  </div>
  <div class="card-body">

    <form method="post" action="/solicitudes/{{ solicitud.id_solicitud }}/comentarios" class="needs-validation" novalidate>
      <div class="mb-2">
        <textarea class="form-control" name="comentario" rows="3" maxlength="4000" required placeholder="Escribe un comentario..."></textarea>
        <div class="invalid-feedback">Escribe un comentario.</div>
      </div>
      <button class="btn btn-outline-primary btn-sm">Enviar</button>
    </form>

    <hr>

    {% for c in comentarios %}
      <div class="mb-3">
        <div class="d-flex justify-content-between">
          <div class="fw-semibold">{{ c.actor_nombre }} <span class="text-muted small">({{ c.actor_rol }})</span></div>
          <div class="text-muted small">{{ c.created_at_utc | fmtDT }}</div>
        </div>
        <div style="white-space: pre-wrap;">{{ c.comentario }}</div>
      </div>
      {% if not loop.last %}<hr class="my-2">{% endif %}
    {% else %}
      <div class="text-muted">Aún no hay comentarios.</div>
    {% endfor %}
    {% set comShown = comPager.page * comPager.size %}
{% if comShown < comPager.total %}
  <a class="btn btn-outline-secondary btn-sm"
     href="/solicitudes/{{ solicitud.id_solicitud }}?comPage={{ comPager.page + 1 }}&histPage={{ histPager.page }}">
    Cargar más comentarios
  </a>
{% endif %}

  </div>
</div>


      <div class="card-body">
        {% for h in historial %}
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-start gap-2">
              <div>
                <span class="badge text-bg-secondary">{{ h.accion }}</span>
                <div class="fw-semibold mt-1">{{ h.resumen or '-' }}</div>
                <div class="text-muted small">{{ h.actor_nombre }} ({{ h.actor_rol }})</div>
              </div>
              <div class="text-muted small text-end">{{ h.created_at_utc }}</div>
            </div>

            {% if h.cambios_json %}
              <details class="mt-2">
                <summary class="small">Ver cambios</summary>
                <pre class="bg-light border rounded p-2 mt-2 small" style="white-space: pre-wrap;">{{ h.cambios_json }}</pre>
              </details>
            {% endif %}
          </div>
          {% if not loop.last %}<hr class="my-2">{% endif %}
        {% else %}
          <div class="text-muted">Sin historial</div>
        {% endfor %}
        {% set histShown = histPager.page * histPager.size %}
{% if histShown < histPager.total %}
  <a class="btn btn-outline-secondary btn-sm"
     href="/solicitudes/{{ solicitud.id_solicitud }}?histPage={{ histPager.page + 1 }}&comPage={{ comPager.page }}">
    Cargar más historial
  </a>
{% endif %}

      </div>
    </div>
  </div>
</div>
{% endblock %}
